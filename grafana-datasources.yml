apiVersion: 1

datasources:
  - name: Prometheus
    type: prometheus
    url: http://prometheus:9090
    access: proxy
    uid: prometheus-ds
    isDefault: true
  
  - name: Jaeger
    type: jaeger
    access: proxy
    url: http://jaeger:16686
    uid: jaeger-ds
    readOnly: false
    editable: true
    jsonData:
      tracesToLogsV2:
        datasourceUid: loki-ds
        spanStartTimeShift: 1h
        spanEndTimeShift: -1h
        mappedTags:
        - key: service.name
          value: service
        - key: trace_id
          value: trace_id
        filterByTraceID: true
        filterBySpanID: false
        customQuery: false
      tracesToMetrics:
        datasourceUid: 'prometheus-ds'
        tags: [{ key: 'service.name', value: 'service' }]
        queries:
          - name: 'Service Request Rate (5m)'
            query: 'sum(rate(traces_spanmetrics_latency_count{service="$$__span.tags.service.name"}[5m])) by (service)'
          - name: 'Service Error Rate (5m)'
            query: 'sum(rate(traces_spanmetrics_latency_count{service="$$__span.tags.service.name", status_code="error"}[5m])) by (service)'
          - name: 'Service P95 Latency (5m)'
            query: 'histogram_quantile(0.95, sum(rate(traces_spanmetrics_latency_bucket{service="$$__span.tags.service.name"}[5m])) by (le, service))'
      nodeGraph:
        enabled: true

  - name: Loki
    type: loki
    access: proxy
    url: http://loki:3100
    uid: loki-ds
    readOnly: false
    editable: true
    jsonData:
      logMessage: "${__line__} | json"
      derivedFields:
        - name: trace_id
          matcherRegex: '"trace_id":"(\w+)"'
          datasourceUid: jaeger-ds
          url: '"$${__value.raw}"'
          urlDisplayLabel: 'View Trace'